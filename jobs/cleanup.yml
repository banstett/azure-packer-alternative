parameters:
  name: ''
  variable_group1: ''
  vm_name: ''
  rg_name: ''

jobs:
- job: ${{ parameters.name }}
  timeoutInMinutes: 30
  pool:
    name: 'Self-Hosted'
  container: kagarlickij/packer-ansible-azure-docker-runtime:2.0.0
  variables:
  - group: ${{ parameters.variable_group1 }}
  steps:
  - checkout: self
    clean: true
    persistCredentials: false
    submodules: false
  - task: AzureCLI@1
    condition: succeeded()
    inputs:
      azureSubscription: $(azureSubscription)
      scriptLocation: inlineScript
      inlineScript: |
        az group delete --name ${{ parameters.rg_name }} --yes
      failOnStandardError: true
    name: 'delete_rg'
    displayName: 'Delete Resource group'

  - task: AzureCLI@1
    condition: succeeded()
    inputs:
      azureSubscription: $(azureSubscription)
      scriptLocation: inlineScript
      inlineScript: |
        az image delete --ids '/subscriptions/$(azureSubscriptionId)/resourceGroups/$(packerImagesResourceGroupName)/providers/Microsoft.Compute/images/${{ parameters.vm_name }}'
      failOnStandardError: true
    name: 'delete_image'
    displayName: 'Delete Image'
